import{_ as i}from"./chunks/K3s.D1n5sSLf.js";import{_ as t}from"./chunks/under-construction.CuWjDGLh.js";import{_ as n,c as l,o as r,j as e,a0 as p,a as o,t as h}from"./chunks/framework.Do9hWntK.js";const C=JSON.parse('{"title":"K3s Cluster Configuration","description":"Setup details","frontmatter":{"title":"K3s Cluster Configuration","description":"Setup details"},"headers":[],"relativePath":"5-Kubernetes/k3s-Setup.md","filePath":"5-Kubernetes/k3s-Setup.md"}'),d={name:"5-Kubernetes/k3s-Setup.md"},k={id:"frontmatter-title",tabindex:"-1"};function c(a,s,g,u,b,F){return r(),l("div",null,[e("h1",k,[o(h(a.$frontmatter.title)+" ",1),s[0]||(s[0]=e("a",{class:"header-anchor",href:"#frontmatter-title","aria-label":'Permalink to "{{ $frontmatter.title }}"'},"‚Äã",-1))]),s[1]||(s[1]=p('<p align="center"><img alt="k3s" src="'+i+`" width="25%"></p><h2 id="overview" tabindex="-1">üëÅÔ∏è Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;:eye: Overview&quot;">‚Äã</a></h2><p>K3d is a lightweight Kubernetes distribution. It is CNCF Certified project and it is designed for resources limited evnironments, an ideal choice for a mini data center.</p><p>K3s has two primary roles:</p><ul><li><strong><code>K3s-Server:</code></strong> Runs server components: control place, scheduler, cloud-controller, helm-controller, etcd, API server, kubelet and kube-proxy. Note that master nodes can also run worker node simultneously.</li><li><strong><code>K3s-Agent:</code></strong> Runs worker node components: kubelet and kube-proxy</li></ul><h2 id="cluster-architecture-configuration" tabindex="-1">Cluster Architecture configuration <a class="header-anchor" href="#cluster-architecture-configuration" aria-label="Permalink to &quot;Cluster Architecture configuration&quot;">‚Äã</a></h2><p>Cluster currently consists of 4 nodes and is planned to expand to meet the high availability setup in near future.</p><h3 id="master-nodes" tabindex="-1">Master Nodes <a class="header-anchor" href="#master-nodes" aria-label="Permalink to &quot;Master Nodes&quot;">‚Äã</a></h3><ul><li><strong><code>berry01</code></strong> (10.0.0.5) - Primary master node</li><li><strong><code>berry02</code></strong> (10.0.0.6) - Secondary master node</li></ul><h3 id="worker-nodes" tabindex="-1">Worker Nodes <a class="header-anchor" href="#worker-nodes" aria-label="Permalink to &quot;Worker Nodes&quot;">‚Äã</a></h3><ul><li><strong><code>berryw10</code></strong> (10.0.0.11) - Raspberry Pi 4B worker</li><li><strong><code>berryw11</code></strong> (10.0.0.12) - Raspberry Pi 5 worker</li></ul><h2 id="setup-pre-requisites" tabindex="-1">Setup Pre-requisites <a class="header-anchor" href="#setup-pre-requisites" aria-label="Permalink to &quot;Setup Pre-requisites&quot;">‚Äã</a></h2><p>Steps to action on all nodes before K3s installation to ensure smooth start.</p><h3 id="enable-cgroup" tabindex="-1">Enable cgroup <a class="header-anchor" href="#enable-cgroup" aria-label="Permalink to &quot;Enable cgroup&quot;">‚Äã</a></h3><p>For Raspberry Pi by default this is not enabled and Kubernetes would not start successfully. Target file: <code>/boot/firmware/cmdline.txt</code> or <code>/boot/firmware/current/cmdline.txt</code> check the system before executing</p><p><strong>Checks:</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check existing setup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cgroup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/fs/cgroup/cgroup.controllers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> memory</span></span></code></pre></div><p><strong>Update:</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add to the existing kernel parameters in the same line:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;s/$/ cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory/&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/firmware/current/cmdline.txt</span></span></code></pre></div><h3 id="enable-bridge-networking" tabindex="-1">Enable Bridge Networking <a class="header-anchor" href="#enable-bridge-networking" aria-label="Permalink to &quot;Enable Bridge Networking&quot;">‚Äã</a></h3><p>Bridge networking lets pods communicate with each other and the host via a virtual network. It‚Äôs needed for consistent pod networking and isolation in Kubernetes.</p><p><strong>Checks:</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check if netfilter settings are correct</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Expected:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check if iptables are enabled to process bridged traffic by loading the required kernel module:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/modules-load.d/k8s.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#Expected: br_netfilter</span></span></code></pre></div><p><strong>Update:</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enable iptables kernel module</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;br_netfilter&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/modules-load.d/k8s.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># enable netfilter</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span></code></pre></div><h3 id="disable-swap" tabindex="-1">Disable Swap <a class="header-anchor" href="#disable-swap" aria-label="Permalink to &quot;Disable Swap&quot;">‚Äã</a></h3><p>Ruuning Kubernetes with acitve swap is not advised, it can affect pod stability as kubelet does not ‚Äúsee‚Äù memory in swap. Swap can also adversly affect the lifespan of your MicroSD cards.</p><p><strong>Checks:</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check if swap is being allocated and used</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">free</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">htop</span></span></code></pre></div><p><strong>Update:</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Temporary disable swap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> swapoff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># For persistant removal of swap comment outw with &#39;#&#39; swap entries in file below  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/fstab</span></span></code></pre></div><p>...</p><p>...</p><p align="center"><img alt="pikube-logo" src="`+t+'" width="40%"></p>',34))])}const v=n(d,[["render",c]]);export{C as __pageData,v as default};
